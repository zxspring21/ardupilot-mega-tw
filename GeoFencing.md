==ArduPlan 地理圍欄 ==

ArduPlane 提供地理圍欄的功能允許你設定虛擬「圍欄」，它可以指定範圍、多邊形的GPS位置，加上最低和最高海拔。

當圍欄的功能被開啟，如果飛行器超過設定的範圍就會切換到導引(GUIDED)模式，讓他飛回設定的範圍內，到了圍欄內就可以使用發射器的開關控制權就會又回到你的手上。

![http://wiki.ardupilot-mega.googlecode.com/git/images/geofencing/geofence.png](http://wiki.ardupilot-mega.googlecode.com/git/images/geofencing/geofence.png)

### 使用RC訓練 ###

地理圍欄的主要用途之一是教自己（或別人）無線電控制飛機飛行。當你有一個正確配置的地理圍欄，它是非常困難崩解的，你可以嘗試練習，通常會很難崩解，飛機在飛行前請關閉電子圍欄避免不必要的災害。

電子圍欄可以結合任何APM飛行模式。因此如果是初學者，請結合的穩定的飛行模式（如 STABILIZE 或 FBWA）之一。一旦操作員已經取得了一些信心，可以結合手動模式，直接控制飛機和允許的最有趣的特技飛行練習。當你學會了這個方式，透過舵機的控制就可以防止你到電子圍欄外或超過定義的高度範圍。

## 設定地理圍欄 ##

要設置地理圍欄！ArduPlane需要設置六個項目：

  1. 邊界圍欄是一組GPS所組成的點
  1. 超出圍欄時的動作
  1. 返回點的位置
  1. 地理圍欄最大與最小的高度
  1. RC發射器需要準備一組通道給地理圍欄
  1. 超出圍欄時你要如何拿回控制

這些都可以使用 Mission Planner 設置，最近的 Planner 也支援地理圍欄，所以你可能會注意到有些界面已經改善了。

當你在設定地理圍欄時有些規則你必須要遵守：

  1. 返回點必須在邊界圍欄之內
  1. 圍欄邊界必須完全的封閉，意思是說至少必須要有四個點，最後一個點要與開始點是同一個點
  1. 邊界最多可以有18個點

如果你要使用 Mission Planner 設定圍欄應該要確實遵守這些規則。

請記住設置圍欄邊界時你的飛機將有一定的動量，當它擊中圍欄，將需要一段時間回到折返點。對於 SkyWalker 這樣的飛機我們建議一個額外的安全邊際，你要飛的真實邊界內約 30米。這個規則同樣適用於最低高度，你需要給 APM 回升足夠的高度，至於實際要多少取決於你飛機的特性。

除了圍欄邊界，以下 MAVLink 參數控制電子圍欄的特性：

  1. FENCE\_ACTION - 這個動作建於超出圍欄。預設值為0，關閉電子圍欄。設定1則為開啟，當超出圍欄時飛行至折返點。
  1. FENCE\_MINALT - 設定以米為單位的最小高度，如果為0就是沒有最低高度。
  1. FENCE\_MAXALT - 設定以米為單位的最大高度，如果為0就是沒有最大高度。
  1. FENCE\_CHANNEL - RC監視電子圍欄的頻道，預設值為0，關閉電子圍欄。 RC輸入通道應該將它設置為備用，連接到你的發射器上的兩段開關。當此通道的PWM設置為1750以上，電子圍欄就會啟動。如果你的發射機支援這個功能可以使用蜂鳴器(每隔幾秒響一下)來提醒你這會是一個不錯的主意，你的頭就不用一直向下監看圍欄。
  1. FENCE\_TOTAL - 電子圍欄中的點數(折返點，加上封閉的邊界)。這個應該在建立圍欄的時候Mission Planner就設置好了。

還有一個額外的參數在電子圍欄中可能會用到。當你超出圍欄，飛機會切換至 GUIDED 模式，飛回折返點。一旦回到圍欄邊境內你就可以拿回控制權，你需要告訴 APM 要取得控制，你可以有3種方式。
  1. 使用發射器上 APM 模式開關改變模式
  1. 使用 FENCE\_CHANNEL 通道關閉及重啟電子圍欄
  1. 設定 RST\_SWITCH\_CH MAVLink 參數，設定到另一個2段彈簧開關。RST\_SWITCH\_CH parameter 預設為0(關閉功能)，如果你設定它至某一個通道，就可以在超出圍欄時使用這個通道開關拿回控制權。

我發現使用的RST\_SWITCH\_CH是電子圍欄的最佳選擇，因為它意味著整個飛行過程中啟用了圍欄，你透過任何動作改變模式開關。雖然它採取了另一個通道，但有些人可能沒有足夠的通道來使用它。

### 設定圍欄邊界 ###

要設置圍欄邊界你必須要到 Mission Planner 的 Flight Planner 頁面。

首先滑鼠移至你想要的位置點擊右鍵設置折返點，並選擇「Set return location」。折返點應設置於飛行範圍的中間位置，並且在站著飛行時可以很容易看見的範圍。

當你設置了折返點，在圍欄邊界的第一點點擊右鍵，選擇「Draw Polygon -> Add polygon point」，然後你就會在多邊形模式，點擊左鍵加入圍欄的的每一個點，planner 會自動完成最後一個點連接到第一個多邊形。

然後，點擊右鍵選擇“地理圍欄上傳發送您的柵欄邊界到 APM，上傳之前 Planner 會要求您輸入柵欄的最低和最高高度(米)，還可以保存柵欄的設置檔案。

### 返回點的高度 ###

如果把 FENCE\_MINALT 及 FENCE\_MAXALT 設置其他大於0的值(FENCE\_MAXALT 大於 FENCE\_MINALT)返回點的高度又只有 FENCE\_MINALT 和 FENCE\_MAXALT 的一半。

如果你不設置 FENCE\_MINALT 和 FENCE\_MAXALT(即他們的距離為0)返回點的高度將由ALT\_HOLD\_RTL的參數控制，也就是使用的RTL模式。請注意單位 ALT\_HOLD\_RTL 是厘米，而 FENCE\_MINALT FENCE\_MAXALT 是米。

如果您的飛行俱樂部和當地的飛行規則不設置最高的高度，那麼我們建議您最大高度最多122米(約 400英尺)。除此之外高度太高操控會變得相當困難，與您的模型保持良好的視線。

折返點的 FENCE\_MINALT 定為30米(保持一些俯衝動能)FENCE\_MAXALT 設為122米、76米，這是一個相當良好的飛行高空。

### 混控(stick mixing)超過圍欄 ###

在自動模式時，APM 預設啟動「stick mixing」，這意味著，你可以改變飛行的路徑，例如，你可以使用發射器上的遙桿。

當您使用地理圍欄時混控會因為超出圍欄而被禁用，直到你的飛機又回來了圍欄區域內。這是為了確保不良輸入控制不會因超出圍欄而回不到折返點。

一旦你回到圍欄內混控將重新啟用，讓您控制這架飛機的GUIDED模式。如果你使用混控又超過圍欄功能就又會被關閉直到你回到圍欄內。

## 地理圍欄飛行的秘訣 ##

電子圍欄在地面上起飛時禁用。要小心不要在地面上使用，因為它可能會提示超出了圍欄，並嘗試飛往折返點。

降落也是禁用，當你在違反高度下將很難降落！

如果您使用的APM1要在手動模式結合地理圍欄，記住APM1的APM軟件繞過第8通道模式開關和 PWM 1750以上的開關(這就是 APM1 上所謂的「hardware manual」)。所以，你要么需要設置不同的手動開關的位置，或者使用不同的模式開關控制通道（並且設置 FLTMODE\_CH 到正在使用的通道）。

之前起飛和飛地理圍欄確保所有參數都設置如上所述，也確保你有一個良好的GPS鎖定。如果你失去GPS鎖定地理圍欄也會關閉，直到GPS鎖恢復，如果你的GPS信號很微弱請不要使用它。

我也建議你先做輕微的測試。試著慢慢接近圍欄邊界，並確保它正確的「反彈」虛擬牆和返回到折返點都是 OK 的。然後再次拿回控制，嘗試慢慢接近最低高度，並確保它彈回您所設置的 FENCE\_MINALT 。

在發展電子圍欄時，我發現與手動模式結合是最好玩的。它給你所有的手動飛行的興奮與急轉彎和花式特技，同時當你犯錯誤時不會毀了一架飛機。

### 飛行範例 ###

這是我的 SkyWalker 開啟電子圍欄時的飛行軌道，白線是電子圍欄邊界，在中間加上可見的折返點，您還可以看到飛機超出地理圍欄到北部、西部和南部的點，也有許多點超出高度，我使用這個功能嘗試改善我的手動模式飛行技巧，飛機如果沒有電子圍欄可能已經無法存活。

![http://wiki.ardupilot-mega.googlecode.com/git/images/geofencing/geofence-CMAC.jpg](http://wiki.ardupilot-mega.googlecode.com/git/images/geofencing/geofence-CMAC.jpg)

請注意，在這個例子中的電子圍欄沿跑道中間運行。這是符合當地俱樂部的規則。起飛和降落禁用電子圍欄。FENCE\_CHANNEL設置為 7，RST\_SWITCH\_CH設置為 6。這允許我起飛後用一個開關啟動圍欄，超出後使用彈簧教練開關拿回控制權。

### 支援 MAVLink ###

APM可透過 MAVLink 回報圍欄的狀態。關鍵狀態數據包被稱為 FENCE\_STATUS，並在[ardpilotmega.xml](http://code.google.com/p/ardupilot-mega/source/browse/libraries/GCS_MAVLink/message_definitions/ardupilotmega.xml)中定義。一個典型的FENCE\_STATUS數據包看起來像這樣：

```
2011-12-20 16:36:35.60: FENCE_STATUS {breach_status : 1, breach_count : 15, breach_type : 1, breach_time : 1706506}
```

如果在圍欄內 breach\_status 為0，如果在外為1。breach\_count 是你這次飛行超出幾次圍欄。breach\_type 是最後超出圍欄的類型(ardupilotmega.xml FENCE\_BREACH 有列舉)。breach\_time是從 APM 開機到超出圍欄的時間以milliseconds為單位。

在未來的 APM Planner 應會支援在飛行過程中宣告地理圍欄狀態。

## 進階功能 ##

ArduPlane 的地理圍欄也可使用失效保護(failsafe)系統，為 OutBack 競賽的挑戰。對於這些類型的事件，像往常一樣定義您的圍欄邊界，但可以在 APM\_Config.h 增設 FENCE\_TRIGGERED\_PIN 選項的APM。這個選項讓你可以設定當超出圍欄時 APM 的數位PIN為High，可以將這個PIN連到飛機上的失效保護(failsafe)設備觸發失效保護模式(OBC 的競爭，需要設置飛機俯衝至地面的極端伺服值)